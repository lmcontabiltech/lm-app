<div class="main-container">
  <div class="header-container">
    <h2>Agenda</h2>
    <div class="header-actions">
      <div class="select-container">
         <app-select-padrao
            label="Agenda"
            [options]="Agenda"
            [(selectedValue)]="selectedAgenda"
            [showDefaultOption]="false"
            (selectedValueChange)="onAgendaChange()">
        </app-select-padrao>
      </div>
      <div class="view-toggle">
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'week'"
          (click)="setView('week')"
        >
          Semana
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'month'"
          (click)="setView('month')"
        >
          Mês
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'year'"
          (click)="setView('year')"
        >
          Ano
        </button>
      </div>
      <button class="btn btn-primary" (click)="adicionarEvento()">Evento +</button>
    </div>
  </div>

  <div class="subMain-container">
    <!-- VISÃO SEMANAL -->
    <ng-container *ngIf="viewMode === 'week'">
      <app-semanal
        [weekDays]="weekDays"
        [diaSemana]="diaSemana"
        [horasDoDia]="horasDoDia"
        [hoje]="hoje"
        [getEventosNoHorario]="getEventosNoHorario.bind(this)"
        (prevPeriod)="prevPeriod()"
        (nextPeriod)="nextPeriod()"
        (eventClick)="openDetalheEventoModal($event)"
      ></app-semanal>
    </ng-container>

    <!-- VISÃO MENSAL -->
    <ng-container *ngIf="viewMode === 'month'">
      <app-mensal
        [meses]="meses"
        [diaSemana]="diaSemana"
        [selectedMonth]="selectedMonth"
        [selectedYear]="selectedYear"
        [monthDays]="monthDays"
        [hoje]="hoje"
        [getEventosDoDia]="getEventosDoDia.bind(this)"
        (prevPeriod)="prevPeriod()"
        (nextPeriod)="nextPeriod()"
        (dayClick)="openEventosDoDiaModal($event)"
        (eventClick)="openDetalheEventoModal($event)"
      ></app-mensal>
    </ng-container>

    <!-- VISÃO ANUAL -->
    <ng-container *ngIf="viewMode === 'year'">
      <app-anual
        [selectedYear]="selectedYear"
        [meses]="meses"
        [diaSemana]="diaSemana"
        [yearMonths]="yearMonths"
        [getMonthMatrix]="getMonthMatrix.bind(this)"
        [hoje]="hoje"
        [getEventosDoDia]="getEventosDoDia.bind(this)"
        (prevPeriod)="prevPeriod()"
        (nextPeriod)="nextPeriod()"
        (eventClick)="openDetalheEventoModal($event)"
      ></app-anual>
    </ng-container>
  </div>
</div>

<app-feedback></app-feedback>
<app-loading *ngIf="isLoading"></app-loading>

<ng-template #formCadastroTemplate>
    <div class="forms-container">
        <form class="modal-form" [formGroup]="eventoForm">
          <div class="form-group">
              <label for="titulo">Titulo</label>
              <input formControlName="titulo" type="text" placeholder="Insira um titulo para o evento" />
          </div>

            <div class="form-group">
                <label for="data">Data</label>
                <input formControlName="data" type="date" />
            </div>

            <div class="input-duo">
              <div class="form-group">
                  <label for="horaInicio">Hora Início</label>
                  <input formControlName="horaInicio" type="time" />
              </div>
              <div class="form-group">
                  <label for="horaFim">Hora Fim</label>
                  <input formControlName="horaFim" type="time" />
              </div>
            </div>

            <div class="form-group">
                <label for="frequencia">Frequência do evento</label>
                <app-select-padrao
                  label="Frequência"
                  [options]="frequencia"
                  [(selectedValue)]="selectedFrequencia"
                  [showDefaultOption]="false"
                  formControlName="frequencia">
                </app-select-padrao>
            </div>

            <div class="input-duo">
              <div class="form-group">
                  <label for="tipoEvento">Tipo</label>
                  <app-select-padrao
                    label="Tipo"
                    [options]="TipoEvento"
                    [(selectedValue)]="selectedTipo"
                    [showDefaultOption]="false"
                    formControlName="tipoEvento">
                  </app-select-padrao>
              </div>
              <div class="form-group">
                  <label for="cor">Cor</label>
                  <input type="hidden" formControlName="cor" />
                    <div class="color-dropdown" (click)="toggleDropdown()">
                      <div class="selected-color-container">
                        <div
                          class="selected-color"
                          [ngStyle]="{ 'background-color': eventoForm.get('cor')?.value }"
                        ></div>
                        <div class="arrow-down" [ngClass]="{ 'icon-rotate': dropdownOpen }">
                          <img src="assets/icones/carret.svg" alt="Arrow down" />
                        </div>
                      </div>
                      <div class="color-options" *ngIf="dropdownOpen">
                        <div
                          *ngFor="let cor of cores"
                          class="color-option"
                          [ngStyle]="{ 'background-color': cor }"
                          [class.selected]="eventoForm.get('cor')?.value === cor"
                          (click)="selecionarCor(cor); $event.stopPropagation()"
                        ></div>
                      </div>
                  </div>
                </div>
            </div>

            <div class="form-group">
                <label>Agenda</label>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="pessoal" name="agenda" value="PESSOAL" formControlName="agenda" checked>
                        <label for="pessoal">Agenda (Pessoal)</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="coordenador" name="agenda" value="GERAL" formControlName="agenda">
                        <label for="coordenador">Agenda (Compartilhada)</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
              <label for="participantes">Participantes</label>
              <app-input-participantes
                [colaboradores]="colaboradores"
                [participantes]="eventoForm.get('participanteIds')?.value"
                (participantesChange)="eventoForm.get('participanteIds')?.setValue($event)"
                formControlName="participanteIds"
              ></app-input-participantes>
            </div>

            <div class="form-group">
                <label for="link">Link da reunião</label>
                <input formControlName="link" type="text" placeholder="Insira o link da reunião" />
            </div>

            <div class="form-group">
                <label for="descricao">Descrição</label>
                <textarea formControlName="descricao" placeholder="Digite uma descrição para o evento" type="text"></textarea>
            </div>
        </form>
    </div>
</ng-template>

<ng-template #detalheEventoTemplate>
  <div class="evento-detalhe">
    <div class="header">
      <span class="dot" [ngStyle]="{ 'background-color': eventoSelecionado?.cor || '#7C7C7C' }"></span>
      <h3>{{ eventoSelecionado?.titulo }}</h3>
    </div>
    <div class="info-container">
      <div class="info-item">
        <label>Data</label>
        <p>{{ eventoSelecionado?.data | date:'dd/MM/yyyy' }}</p>
      </div>
      <div class="info-duo">
        <div class="info-item">
          <label>Hora de inicio</label>
          <p>{{ eventoSelecionado?.horaInicio }}</p>
        </div>
        <div class="info-item">
          <label>Hora de fim</label>
          <p>{{ eventoSelecionado?.horaFim }}</p>
        </div>
      </div>
      <div class="info-duo">
        <div class="info-item">
          <label>Tipo de evento</label>
          <p>{{ getTipoDescricao(eventoSelecionado?.tipoEvento) }}</p>
        </div>
        <div class="info-item">
          <label>Agenda</label>
          <p>{{ getAgendaDescricao(eventoSelecionado?.agenda) }}</p>
        </div>
      </div>
      <div class="info-item">
          <label>Link</label>
          <p *ngIf="eventoSelecionado?.link">
            <a [href]="eventoSelecionado?.link" target="_blank" rel="noopener" style="word-break: break-all;">{{ eventoSelecionado?.link || '-' }}</a>
          </p>
      </div>
      <div class="info-item">
          <label>Descrição</label>
          <p *ngIf="eventoSelecionado?.descricao">{{ eventoSelecionado?.descricao || '-' }}</p>
      </div>
      <div *ngIf="eventoSelecionado?.participanteIds?.length">
        <strong>Participantes:</strong>
        <ul>
          <li *ngFor="let p of eventoSelecionado?.participanteIds">{{ p }}</li>
        </ul>
      </div>
    </div>
  </div>
</ng-template>

<!-- Modal: Lista de Eventos do Dia -->
<ng-template #listaEventosDiaTemplate>
  <div class="lista-eventos-dia">
    <h3>Eventos de {{ dataSelecionada | date:'dd/MM/yyyy' }}</h3>
    <div *ngIf="eventosDoDiaSelecionado?.length; else semEventos">
      <div class="evento-item" *ngFor="let ev of eventosDoDiaSelecionado" (click)="openDetalheEventoModal(ev)">
        <span class="dot" [ngStyle]="{ 'background-color': ev.cor || '#7C7C7C' }"></span>
        <div class="texto">
          <div class="titulo">{{ ev.titulo }}</div>
          <div class="sub">
            <span *ngIf="ev.horaInicio">{{ ev.horaInicio }}</span>
            <span *ngIf="ev.horaFim"> - {{ ev.horaFim }}</span>
            <span> • {{ getTipoDescricao(ev.tipoEvento) }}</span>
          </div>
        </div>
      </div>
    </div>
    <ng-template #semEventos>
      <p>Sem eventos neste dia.</p>
    </ng-template>
  </div>
</ng-template>
